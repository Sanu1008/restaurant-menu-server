<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Menu Items</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h2 class="mb-4 text-center text-success">Menu Management</h2>
  
  <div class="mb-3 text-end">
    <button class="btn btn-success" onclick="showAddForm()">âž• Add New Item</button>
  </div>

  <!-- Add/Edit Form -->
  <div id="formContainer" style="display:none;" class="mb-4 border p-3 rounded">
    <h5 id="formTitle">Add New Item</h5>
    <form id="menuForm">
      <input type="hidden" id="itemId">
      <div class="mb-3">
        <label class="form-label">Item Name</label>
        <input type="text" id="itemName" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Category</label>
        <input type="text" id="itemCategory" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea id="itemDescription" class="form-control" rows="2" required></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Variants (Format: Large:3,Medium:2,Small:1.5)</label>
        <input type="text" id="itemVariants" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Image</label>
        <input type="file" id="itemImage" class="form-control" accept="image/*">
        <img id="imagePreview" src="" alt="Preview" class="mt-2 rounded" style="max-width:150px; display:none;">
      </div>
      <button type="submit" class="btn btn-success">Save</button>
      <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancel</button>
    </form>
    <div id="formStatus" class="mt-2"></div>
  </div>

  <!-- Menu Table -->
  <table class="table table-bordered table-striped">
    <thead class="table-success">
      <tr>
        <th>Name</th>
        <th>Category</th>
        <th>Description</th>
        <th>Variants</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="menuTableBody"></tbody>
  </table>
</div>

<script>
const BACKEND_URL = "https://restaurant-menu-server.onrender.com"; // Your backend

let menuData = [];

// Fetch menu items from backend
async function loadMenu() {
  try {
    const res = await fetch(BACKEND_URL + "/menu");
    const data = await res.json();
    const tbody = document.getElementById('menuTableBody');
    tbody.innerHTML = '';

    if (Array.isArray(data)) {
      menuData = data.map(item => ({
        id: item.id,
        Name: item.Name,
        Category: item.Category,
        Description: item.Description,
        Variants: item.Variants,
        ImageBase64: item.ImageBase64 || ""
      }));

      menuData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.Name}</td>
          <td>${item.Category}</td>
          <td>${item.Description}</td>
          <td>${item.Variants}</td>
          <td>
            <button class="btn btn-sm btn-primary me-1 edit-btn" data-id="${item.id}">Edit</button>
            <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Attach event listeners
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editItem(btn.getAttribute('data-id')));
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteItem(btn.getAttribute('data-id')));
      });
    }
  } catch (err) {
    console.error("Error loading menu:", err);
  }
}

// Show/hide form
function showAddForm() {
  document.getElementById('formContainer').style.display = 'block';
  document.getElementById('formTitle').innerText = 'Add New Item';
  document.getElementById('menuForm').reset();
  document.getElementById('itemId').value = '';
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('formStatus').innerHTML = '';
}
function hideForm() {
  document.getElementById('formContainer').style.display = 'none';
}

// Edit item
function editItem(id) {
  const item = menuData.find(i => i.id == id);
  if (!item) return;

  showAddForm();
  document.getElementById('formTitle').innerText = 'Edit Item';
  document.getElementById('itemId').value = item.id;
  document.getElementById('itemName').value = item.Name;
  document.getElementById('itemCategory').value = item.Category;
  document.getElementById('itemDescription').value = item.Description;
  document.getElementById('itemVariants').value = item.Variants;

  const preview = document.getElementById('imagePreview');
  if (item.ImageBase64) {
    preview.src = `data:image/png;base64,${item.ImageBase64}`;
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

// Delete item
async function deleteItem(id) {
  if (!confirm("Are you sure you want to delete this item?")) return;

  try {
    const res = await fetch(BACKEND_URL + "/update-menu", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, action: "delete" })
    });
    const data = await res.json();
    if (data.status === "success") loadMenu();
    else alert("Error deleting item!");
  } catch (err) {
    console.error(err);
  }
}

// Handle form submission
document.getElementById('menuForm').addEventListener('submit', async e => {
  e.preventDefault();
  const id = document.getElementById('itemId').value;
  const Name = document.getElementById('itemName').value.trim();
  const Category = document.getElementById('itemCategory').value.trim();
  const Description = document.getElementById('itemDescription').value.trim();
  const Variants = document.getElementById('itemVariants').value.trim();
  const imageFile = document.getElementById('itemImage').files[0];

  let ImageBase64 = "";
  if (imageFile) {
    ImageBase64 = await fileToBase64(imageFile);
    ImageBase64 = ImageBase64.split(',')[1];
  } else if (id) {
    const existingItem = menuData.find(i => i.id == id);
    if (existingItem) ImageBase64 = existingItem.ImageBase64 || "";
  }

  const payload = { id, Name, Category, Description, Variants, ImageBase64, action: id ? "update" : "add" };

  try {
    const res = await fetch(BACKEND_URL + "/update-menu", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.status === "success") {
      loadMenu();
      hideForm();
    } else {
      alert("Error saving item!");
    }
  } catch (err) {
    console.error(err);
  }
});

// Convert file to Base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = err => reject(err);
  });
}

// Live image preview
document.getElementById('itemImage').addEventListener('change', e => {
  const file = e.target.files[0];
  const preview = document.getElementById('imagePreview');
  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      preview.src = reader.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    preview.src = '';
    preview.style.display = 'none';
  }
});

// Initial load
loadMenu();
</script>
</body>
</html>
